---
title: "lab_08"
author: "derek willis"
date: "2023-04-03"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load libraries and establish settings

**Task** Create a codeblock and load appropriate packages and settings for this lab. We'll be making some charts, working with dates and retrieving Census data.
```{r}
library(tidyverse)
library(lubridate)
library(tidycensus)
library(janitor)
library(ggthemes)
```



## Load and modify data

**Task** Create a codeblock and load the following data from the data folder:

* Prince George's County 911 Overdose Calls
```{r}
PG_county_calls <- read_csv("data/prince_georges_2022_overdoses.csv")
```


You will need to create columns for the date, week and month based on the existing `datetime` column.

```{r}
PG_county_calls <- PG_county_calls %>%
  mutate(month = month(datetime, label=TRUE)) %>%
  mutate(date = date(datetime)) %>%
  mutate(week = week(datetime))
```


## Questions 

**Q1.** Which month saw the greatest percentage of total calls? Create a dataframe that calculates the percentage of all calls that each month's calls represents. Make a bar chart from that dataframe. Your bar chart must have:

* A clear title that states the main idea/finding
* Good labels for the x & y axis and a caption for the source, which is Prince George's County EMS.
* Readable bars - the values shouldn't be overlapping

Compare the results here to those from the pre_lab_08 bar chart - are there major differences in the months with the highest and lowest figures? Describe that below.

**A1.** The month with the highest percent of calls is December with 10% of calls. Then July and November both have more than 9% of the total calls. There is not a major difference between the 12 months with a difference of 3.51% between the highest and lowest months. In the graph from Baltimore County calls, warmer months had far more calls than colder months. However, in the Prince George's County bar chart, December is the month with the most calls and November is the month with the third most calls. While January is the month with the fewest calls in Prince George's County, the month with the second fewest is August, which had the most calls in Baltimore County.

```{r}
PG_county_call_A1 <- PG_county_calls %>%
  group_by(month) %>%
  summarise (total_calls = n()) %>%
  mutate(percentage = ((total_calls/1397) * 100)) %>%
  arrange(desc(total_calls))

PG_county_call_A1 %>%
  ggplot() +
 geom_bar(aes(x=month, weight=percentage)) +
  theme_minimal() +
  labs(
    title="Little difference in percentage of calls per month",
    x = "month",
    y = "percent of total calls",
    caption = "source: Prince George's County"
    
  )
  
```

**Q2.** Let's visualize this data on a weekly basis using a line chart. As in Q1, generate a dataframe with the total number of calls for each week, and then create a line chart to show the distribution of calls over time. Your line chart must have:

* A clear title that states the main idea/finding
* Good labels for the x & y axis and a caption for the source, which is Prince George's County EMS.
* Readable labels

Describe the pattern of results; you may want to look at the data to dig into particular outliers.

**A2.** The week with the most 911 overdose calls was the 28th week of the year, or the middle of July. While there appears to be an outlier with the 53rd week that only has four calls, but that is because the 53rd week of 2022 is only December 31, 2022, so the other six days of the week are in 2023 and not counted.

```{r}
PG_county_calls_A2 <- PG_county_calls %>%
  group_by(week) %>%
  summarise(total_calls = n()) %>%
  arrange(desc(total_calls))

PG_county_calls_A2 %>%
  ggplot() + 
  geom_line(aes(x=week, y=total_calls)) +
  theme_minimal() +
    labs(
    title="Overdose calls peak in 28th week of year (Mid-July)",
    x = "week",
    y = "number of calls",
    caption = "source: Prince George's County"
    
  )
  
```

**Q3.**  A scatterplot is a type of chart that helps us see relationships between two variables. One variable goes on the x axis, the other on the y axis.  For each row/observation in our data, a scatterplot puts a circle (or a "point") where the two variables intersect on a grid. 

Statisticians use scatterplots to show graphically whether one variable is correlated -- related, in a statistical sense -- with another variable.  A classic example is the [relationship between ice cream sales and temperature](https://www.mathsisfun.com/data/scatter-xy-plots.html). The scatterplot below -- press play to load the image -- shows that relationship, that an increase in temperature is associated with an increase in ice cream sales. When it's 12C, sales are 200 dollars, and when it's hotter, 25C, sales are 600 dollars.

```{r}
knitr::include_graphics("https://www.mathsisfun.com/data/images/scatter-ice-cream1.svg")
```

We're going to use a scatterplot a little differently, to get a visual sense of two key variables: 

Our question is: does the median income in a zip code have any relationship to the number of overdose 911 calls in that zip code?

To answer this question, do the following:

1. Generate a dataframe with the number of 911 calls for each zip code.
2. Get data from the Census Bureau showing median household income for Maryland zip codes.
3. Join those two dataframes on their zip code columns, starting with the 911 calls dataframe.
4. Make a scatterplot showing the total calls and median income. I didn't show you how to do this, so look it up! Googling "ggplot scatterplot" is a good start.
5. Give it an appropriate title, source, and x and y axis titles.
6. Add a label for each point that shows the zip code using geom_text() - see some examples of its use at https://ggplot2.tidyverse.org/reference/geom_text.html#ref-examples. Try to make the names as easy to read as possible by avoiding overlap.
7. In the answer space below, describe what you see and answer the questions posed above. In a general sense, what do you think this means? Feel free to consider the actual raw values: how would you report out the main point(s) of this chart?

**A3.** While zipcodes with a median household income over 125,000 have no more than 25 calls in 2022, there does not appear to be a strong correlation between median household income and number of 911 overdose calls in Prince George's County. Some zipcodes with a lower median household income do have more 911 calls, but others have the same amount or less than the amount of the wealthier zipcodes. In my opinion there is a weak correlation between median household income and number of 911 overdose calls.  I would be careful with reporting on this data because there is not a clear, strong correlation between the two variables so it is hard to tell what is truly happening here. I think it is worth noting that zipcodes with a median household income over 125,000 do not have a lot of overdose calls, but more information is needed to report on the zip codes that share a similar median household income but have different numbers of 911 calls.

```{r}
PG_county_calls_A3 <- PG_county_calls %>%
  group_by(zipcode) %>%
  summarise(total_calls = n())


census_api_key("0c9e4a42e64dc44c0efda2561d52d008a3ffd85d")

 md <- get_acs(geography = "zcta",
              variables = c(medincome = "B19013_001"),
              state = "MD",
              year = 2019)
 PG_county_calls_A3 <- PG_county_calls_A3 %>%
  left_join(md, by=c('zipcode' = 'GEOID'))
 
 PG_county_calls_A3 %>%
   ggplot() +
   geom_point(aes(x=estimate, y=total_calls, label = zipcode)) +
   geom_text(aes(x=estimate, y=total_calls, label = zipcode, vjust = 0, nudge_y = 0.5)) +
     theme_minimal() +
    labs(
    title="Weak correlation between median household income and 911 overdose calls",
    x = "estimate median household income",
    y = "number of calls",
    caption = "source: Prince George's County and Census Bureau"
    
  )
  
   
```
